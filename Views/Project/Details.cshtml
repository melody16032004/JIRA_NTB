@model JIRA_NTB.ViewModels.ProjectDetailViewModel
<style>
    /* Hide scrollbar but allow scrolling */
    .scrollbar-none::-webkit-scrollbar {
        display: none;
    }

    .scrollbar-none {
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
    }
</style>
<div class="flex flex-col gap-3">

    <div class="flex flex-col lg:flex-row gap-2">

        <div class="lg:w-2/3 w-full flex flex-col gap-3">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1.5 h-full bg-indigo-500 rounded-l-xl"></div>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">@Model.Project.ProjectName</h2>
                <div>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded text-sm font-medium bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200">
                        @Model.Project.Status.StatusName
                    </span>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-4 leading-relaxed">
                    @Model.Project.Note
                </p>
                <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 flex flex-wrap gap-3 text-sm">
                    <div class="flex items-center text-gray-600 dark:text-gray-400">
                        <i data-lucide="calendar" class="w-4 h-4 mr-2"></i>
                        <span>Bắt đầu: @Model.Project.StartDay?.ToString("dd/MM/yyyy")</span>
                    </div>
                    <div class="flex items-center text-gray-600 dark:text-gray-400">
                        <i data-lucide="calendar-check" class="w-4 h-4 mr-2"></i>
                        <span>Kết thúc: @Model.Project.EndDay?.ToString("dd/MM/yyyy")</span>
                    </div>
                </div>
            </div>

            <div class="flex-1 flex flex-col">
                @await Html.PartialAsync("~/Views/Project/Partial/_KanbanBoardPartial.cshtml", Model)
            </div>
        </div>

        <div class="lg:w-1/3 w-full flex flex-col gap-3">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Tổng quan trạng thái</h3>
                <div id="taskStatusChart" class="flex justify-center"></div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6 flex flex-col sticky top-6 flex-1">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 shrink-0">
                    Thành viên (@Model.Members.Count)
                </h3>
                <div class="overflow-y-auto max-h-48 scrollbar-none">
                    <ul class="space-y-3 pr-2">
                        @foreach (var member in Model.Members)
                        {
                            <li class="flex items-center space-x-3">
                                <img src="@member.Avt" alt="@member.FullName" class="w-9 h-9 rounded-full ring-2 ring-indigo-500/30 shrink-0">
                                <div class="min-w-0 flex-1">
                                    <p class="text-sm font-medium text-gray-900 dark:text-white truncate">@member.FullName</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 truncate">@member.Email</p>
                                </div>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="flex flex-col gap-3">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Biểu đồ thời gian công việc</h3>
                <span class="text-xs text-gray-500 dark:text-gray-400">Dạng Gantt Chart</span>
            </div>
            <div id="taskTimelineChart" class="min-h-[420px]"></div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md border border-gray-200 dark:border-gray-700">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-semibold dark:text-white">Công việc (@Model.Tasks.Count)</h3>
                <a href="#" class="text-sm text-indigo-600 hover:text-indigo-500">Xem tất cả</a>
            </div>
            <ul class="divide-y divide-gray-200 dark:divide-gray-700">
                @foreach (var task in Model.Tasks.Take(5))
                {
                    <li class="p-4 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-gray-700/50 transition">
                        <span class="text-sm font-medium dark:text-gray-300">@task.NameTask</span>
                        <span class="text-xs px-2 py-0.5 rounded font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                            @task.Status.StatusName
                        </span>
                    </li>
                }
            </ul>
        </div>
    </div>
</div>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script> 
        document.addEventListener("DOMContentLoaded", function() { 
            //Lấy dữ liệu từ ViewModel (được Controller truyền qua) 
            var chartSeries = @Html.Raw(Json.Serialize(Model.TaskStatusChart.Series)); 
            var chartLabels = @Html.Raw(Json.Serialize(Model.TaskStatusChart.Labels)); 
            // Cấu hình biểu đồ Donut 
            var options = { chart: 
            { type: 'donut', height: 300, 
            // Màu chữ cho dark mode
            foreColor: document.body.classList.contains('dark') ? '#d1d5db' : '#d1d5db'    },
            series: chartSeries, labels: chartLabels, 
            plotOptions: { 
                pie: { 
                    donut: { 
                        labels: 
                        {
                         show: true, 
                            total: 
                            { 
                                show: true, 
                                label: 'Tổng số',
                                color: document.body.classList.contains('dark') ? '#d1d5db' : '#d1d5db'
                            } 
                        } 
                    } 
                } 
            }, legend: {
                position: 'bottom' 
            },
            responsive: [{ 
                breakpoint: 480, 
                options: { 
                chart: { 
                width: 200 
            }, 
            legend: { 
            position: 'bottom' } 
            } 
            }] 
            }; 
            // Tạo và render biểu đồ 
            var chart = new ApexCharts(document.querySelector("#taskStatusChart"), options); 
            chart.render(); 
            // Tự khởi tạo lại icons (vì chúng ta đang ở trang mới) 
            lucide.createIcons(); 
            }); 
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var timelineData = @Html.Raw(Json.Serialize(Model.TaskTimelineData));
            console.log("TimelineData:", timelineData);

            if (!timelineData || timelineData.length === 0) {
                document.querySelector("#taskTimelineChart").innerHTML =
                    "<p class='text-gray-500 text-sm text-center py-8'>Không có dữ liệu biểu đồ</p>";
                return;
            }

            function getPriorityColor(priority) {
                switch (priority) {
                    case 'High': return '#dc2626';      // Red-600
                    case 'Medium': return '#f59e0b';    // Amber-500
                    case 'Low': return '#10b981';       // Emerald-500
                    default: return '#8b5cf6';          // Violet-500
                }
            }

            function getPriorityGradient(priority) {
                switch (priority) {
                    case 'High': return { from: '#dc2626', to: '#ef4444' };
                    case 'Medium': return { from: '#f59e0b', to: '#fbbf24' };
                    case 'Low': return { from: '#10b981', to: '#34d399' };
                    default: return { from: '#8b5cf6', to: '#a78bfa' };
                }
            }

            var ganttSeries = [{
            data: timelineData
                .filter(t => t.status !== "Hoàn thành") // Ẩn các task đã hoàn thành
                .map(t => ({
                    x: t.name,
                    y: [t.start, t.end],
                    fillColor: getPriorityColor(t.priority),
                    assignee: t.assignee,
                    priority: t.priority,
                    status: t.status,
                    overdue: t.overdue
                }))
            }];
            var isDark = document.body.classList.contains('dark');

            var ganttOptions = {
                chart: {
                    type: 'rangeBar',
                    height: 420,
                    toolbar: {
                        show: true,
                        tools: {
                            download: true,
                            zoom: true,
                            zoomin: true,
                            zoomout: true,
                            pan: true,
                            reset: true
                        }
                    },
                    foreColor: isDark ? '#D1D5DB' : '#374151',
                    background: 'transparent',
                    animations: {
                        enabled: true,
                        speed: 800,
                        animateGradually: {
                            enabled: true,
                            delay: 150
                        }
                    }
                },
                series: ganttSeries,
                plotOptions: {
                    bar: {
                        horizontal: true,
                        distributed: false,
                        barHeight: '45%',
                        borderRadius: 8,
                        borderRadiusApplication: 'end',
                        dataLabels: {
                            hideOverflowingLabels: false
                        }
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: function(val, opts) {
                        var name = opts.w.config.series[0].data[opts.dataPointIndex].x;
                        return name.length > 25 ? name.substring(0, 25) + '...' : name;
                    },
                    style: {
                        colors: ['#ffffff'],
                        fontSize: '12px',
                        fontWeight: 600,
                        fontFamily: 'Inter, system-ui, -apple-system, sans-serif'
                    },
                    background: {
                        enabled: false
                    },
                    dropShadow: {
                        enabled: true,
                        top: 1,
                        left: 1,
                        blur: 2,
                        opacity: 0.5
                    }
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        datetimeUTC: false,
                        style: {
                            colors: isDark ? '#9CA3AF' : '#6B7280',
                            fontSize: '11px',
                            fontWeight: 500
                        },
                        datetimeFormatter: {
                            year: 'yyyy',
                            month: "MMM 'yy",
                            day: 'dd MMM',
                            hour: 'HH:mm'
                        }
                    },
                    axisBorder: {
                        show: true,
                        color: isDark ? '#4B5563' : '#E5E7EB'
                    },
                    axisTicks: {
                        show: true,
                        color: isDark ? '#4B5563' : '#E5E7EB'
                    }
                },
                yaxis: {
                    labels: {
                        style: {
                            colors: isDark ? '#D1D5DB' : '#D1D5DB',
                            fontSize: '12px',
                            fontWeight: 500
                        },
                        maxWidth: 200
                    }
                },
                tooltip: {
                    theme: isDark ? 'dark' : 'light',
                    custom: function({ dataPointIndex, w }) {
                        var t = w.config.series[0].data[dataPointIndex];
                        var priorityColor = getPriorityColor(t.priority);

                        return `
                            <div style="padding: 12px; min-width: 220px; font-family: Inter, sans-serif;">
                                <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px; color: ${isDark ? '#F3F4F6' : '#111827'};">
                                    ${t.x}
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 6px; font-size: 12px;">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <span style="opacity: 0.7;">👤</span>
                                        <span style="color: ${isDark ? '#D1D5DB' : '#4B5563'};">${t.assignee || 'Chưa phân công'}</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <span style="opacity: 0.7;">🎯</span>
                                        <span style="color: ${priorityColor}; font-weight: 600;">${t.priority}</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <span style="opacity: 0.7;">📅</span>
                                        <span style="color: ${isDark ? '#D1D5DB' : '#4B5563'};">
                                            ${new Date(t.y[0]).toLocaleDateString('vi-VN')}
                                        </span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <span style="opacity: 0.7;">🏁</span>
                                        <span style="color: ${isDark ? '#D1D5DB' : '#4B5563'};">
                                            ${new Date(t.y[1]).toLocaleDateString('vi-VN')}
                                        </span>
                                    </div>
                                </div>
                            </div>`;
                    }
                },
                grid: {
                    borderColor: isDark ? '#374151' : '#E5E7EB',
                    strokeDashArray: 3,
                    xaxis: {
                        lines: {
                            show: true
                        }
                    },
                    yaxis: {
                        lines: {
                            show: true
                        }
                    },
                    padding: {
                        top: 0,
                        right: 15,
                        bottom: 0,
                        left: 10
                    }
                },
                legend: {
                    show: false
                },
                states: {
                    hover: {
                        filter: {
                            type: 'lighten',
                            value: 0.1
                        }
                    },
                    active: {
                        filter: {
                            type: 'darken',
                            value: 0.1
                        }
                    }
                }
            };

            var chart = new ApexCharts(document.querySelector("#taskTimelineChart"), ganttOptions);
            chart.render();

            // Theo dõi thay đổi dark mode
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.attributeName === "class") {
                        chart.destroy();
                        isDark = document.body.classList.contains('dark');
                        ganttOptions.chart.foreColor = isDark ? '#D1D5DB' : '#374151';
                        ganttOptions.xaxis.labels.style.colors = isDark ? '#9CA3AF' : '#6B7280';
                        ganttOptions.xaxis.axisBorder.color = isDark ? '#4B5563' : '#E5E7EB';
                        ganttOptions.xaxis.axisTicks.color = isDark ? '#4B5563' : '#E5E7EB';
                        ganttOptions.yaxis.labels.style.colors = isDark ? '#D1D5DB' : '#374151';
                        ganttOptions.grid.borderColor = isDark ? '#374151' : '#E5E7EB';
                        ganttOptions.tooltip.theme = isDark ? 'dark' : 'light';
                        chart = new ApexCharts(document.querySelector("#taskTimelineChart"), ganttOptions);
                        chart.render();
                    }
                });
            });
            observer.observe(document.body, { attributes: true });
        });
    </script>
}
