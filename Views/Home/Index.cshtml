@* @using JIRA_NTB.Models.Test
@model List<JIRA_NTB.Models.Test.Project> *@
@using Newtonsoft.Json
@* @model List<JIRA_NTB.Models.ProjectModel> *@
@model JIRA_NTB.ViewModels.DashboardViewModel

@{
    ViewData["Title"] = "Tổng quan";
    const int x = -1;
    const int y = -1;
}
<!-- Dashboard Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-6">

    <!-- Card 1 -->
    <div class="bg-gray-900 border-t-4 border-indigo-500 rounded-xl shadow-md p-3 hover:shadow-indigo-500/30 transition transform hover:-translate-y-0.5 duration-300 opacity-0 animate-cardFadeIn delay-[25ms]">
        <div class="flex items-center justify-between">
            <div class="p-2.5 rounded-full bg-indigo-600/20 text-indigo-400">
                <i data-lucide="folder-open-dot" class="w-4 h-4"></i>
            </div>
            <p id="tongduan" class="text-xl font-bold text-white">0</p>
        </div>
        <h3 class="mt-2 text-gray-200 font-semibold text-sm">TỔNG DỰ ÁN</h3>
        <ul class="mt-1.5 text-xs text-gray-400 space-y-0.5">
            <li>• Hoàn thành: <span id="duanhoanthanh" class="text-gray-300 font-medium">0</span></li>
            <li>• Tỷ lệ: <span id="duanhoanthanhpro" class="text-indigo-400 font-medium">0%</span></li>
        </ul>
    </div>

    <!-- Card 2 -->
    <div class="bg-gray-900 border-t-4 border-green-500 rounded-xl shadow-md p-3 hover:shadow-green-500/30 transition transform hover:-translate-y-0.5 duration-300 opacity-0 animate-cardFadeIn delay-[50ms]">
        <div class="flex items-center justify-between">
            <div class="p-2.5 rounded-full bg-green-600/20 text-green-400">
                <i data-lucide="list-checks" class="w-4 h-4"></i>
            </div>
            <p id="tongnhiemvu" class="text-xl font-bold text-white">0</p>
        </div>
        <h3 class="mt-2 text-gray-200 font-semibold text-sm">TỔNG NHIỆM VỤ</h3>
        <ul class="mt-1.5 text-xs text-gray-400 space-y-0.5">
            <li>• Hoàn thành: <span id="nhiemvuhoanthanh" class="text-gray-300 font-medium">0</span></li>
            <li>• Tỷ lệ: <span id="nhiemvuhoanthanhpro" class="text-green-400 font-medium">0%</span></li>
        </ul>
    </div>

    <!-- Card 3 -->
    <div class="bg-gray-900 border-t-4 border-yellow-400 rounded-xl shadow-md p-3 hover:shadow-yellow-400/30 transition transform hover:-translate-y-0.5 duration-300 opacity-0 animate-cardFadeIn delay-[75ms]">
        <div class="flex items-center justify-between">
            <div class="p-2.5 rounded-full bg-yellow-500/20 text-yellow-400">
                <i data-lucide="hourglass" class="w-4 h-4"></i>
            </div>
            <p id="nhiemvudanglam" class="text-xl font-bold text-white">0</p>
        </div>
        <h3 class="mt-2 text-gray-200 font-semibold text-sm">NHIỆM VỤ ĐANG LÀM</h3>
        <ul class="mt-1.5 text-xs text-gray-400 space-y-0.5">
            <li>• Chưa bắt đầu: <span id="nhiemvuchuabd" class="text-gray-300 font-medium">0</span></li>
            <li>• Tạm dừng: <span class="text-gray-300 font-medium">0</span></li>
        </ul>
    </div>

    <!-- Card 4 -->
    <div class="bg-gray-900 border-t-4 border-red-500 rounded-xl shadow-md p-3 hover:shadow-red-500/30 transition transform hover:-translate-y-0.5 duration-300 opacity-0 animate-cardFadeIn delay-[100ms]">
        <div class="flex items-center justify-between">
            <div class="p-2.5 rounded-full bg-red-600/20 text-red-400">
                <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            </div>
            <p id="nhiemvuquahan" class="text-xl font-bold text-white">0</p>
        </div>
        <h3 class="mt-2 text-gray-200 font-semibold text-sm">NHIỆM VỤ QUÁ HẠN</h3>
        <ul class="mt-1.5 text-xs text-gray-400 space-y-0.5">
            <li>• Tổng nhiệm vụ: <span class="text-gray-300 font-medium">0</span></li>
            <li>• Tỷ lệ: <span id="nhiemvuquahanpro" class="text-red-400 font-medium">0%</span></li>
        </ul>
    </div>
</div>

<!-- |||| -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-screen text-gray-200">
    <!-- CỘT TRÁI -->
    <div class="lg:col-span-2 bg-gradient-to-b from-gray-900 to-gray-800 rounded-2xl shadow-lg p-4">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-md font-semibold text-white">Dự án & Nhiệm vụ</h2>
            <div class="flex gap-3">
                <div class="relative flex items-center">
                    <input type="text" id="searchInput"
                           placeholder="Tìm kiếm..."
                           class="bg-gray-800 text-white text-xs pl-9 pr-3 py-2 rounded-lg border border-gray-600 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500 outline-none transition w-60" />
                    <i data-lucide="search"
                       class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                </div>
                <button id="openUpdateProjectBtnAdd#@y#@y" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-xs font-medium transition flex items-center gap-1">
                    <i data-lucide="folder-plus" class="w-4 h-4"></i> Thêm dự án
                </button>
                <button id="openUpdateTaskBtnAdd#@x#@x" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-xs font-medium transition flex items-center gap-1">
                    <i data-lucide="list-plus" class="w-4 h-4"></i> Thêm nhiệm vụ
                </button>
            </div>
        </div>

        <hr class="border-t border-gray-700 my-4" />

        <!-- Danh sách Dự án -->
        <div class="space-y-4">

            <!-- Nút điều khiển -->
            <div class="flex justify-end mb-2 gap-[10px]">
                <div class="relative group cursor-pointer">
                    <div class="flex items-center gap-3 bg-gray-800/80 border-2 border-red-600 rounded-lg px-2 py-2 cursor-pointer hover:bg-red-600/10 transition-all duration-300 shadow-sm group">
                        @* <input type="checkbox" id="priorityHigh" class="w-5 h-5 accent-red-500 cursor-pointer" /> *@
                        <label for="priorityHigh" class="flex items-center gap-2 cursor-pointer select-none">
                            <input type="checkbox" id="priorityHigh" class="hidden peer" />
                            <span class="w-4 h-4 border-2 border-gray-500 rounded peer-checked:bg-red-500 peer-checked:border-red-500 transition-all"></span>
                        </label>

                        <label for="priorityHigh" class="flex items-center gap-2 text-red-400 font-medium cursor-pointer select-none">
                            <i data-lucide="alert-triangle" class="w-4 h-4 text-red-400 group-hover:text-red-300 transition-all"></i>
                            <span class="text-xs group-hover:text-red-300">Ưu tiên cao</span>
                        </label>
                    </div>
                    <span class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-full mr-2
                        bg-gray-900 text-white text-xs rounded-md px-2 py-1 opacity-0 scale-90
                        group-hover:opacity-100 group-hover:scale-100 transition-all duration-200 whitespace-nowrap shadow-lg">
                        Chọn để lọc nhiệm vụ có độ ưu tiên cao
                    </span>
                </div>


                <button id="toggleAllBtn"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition flex items-center gap-1">
                    <i data-lucide="chevron-up" class="w-4 h-4"></i>
                    <span class="text-xs">Thu gọn tất cả</span>
                </button>
            </div>

            @if (Model.Projects == null || !Model.Projects.Any())
            {
                <div class="text-center py-10 text-gray-400 text-lg bg-gray-900/50 rounded-lg flex flex-col items-center justify-center gap-3">
                    <i data-lucide="folder-x" class="w-[80px] h-[80px] text-gray-500"></i>
                    <span>Hiện chưa có dự án nào.</span>
                </div>
            }
            else
            {
                @foreach (var project in Model.Projects)
                {
                    <!-- Dự án 1 -->
                    <div class="bg-gray-800 border border-gray-700 rounded-xl overflow-hidden">
                        <div class="flex justify-between items-center p-4 gap-[20px] cursor-pointer hover:bg-gray-700 transition"
                             data-toggle="project#@project.IdProject">
                            <div class="w-full">
                                <div class="flex items-center justify-between w-full gap-[20px]">
                                    <div class="flex items-center gap-[5px]">
                                        <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400 transition-transform duration-300"></i>
                                        <h3 class="font-semibold text-md text-white">
                                            @* Hệ thống báo cáo nội bộ (P00-@i) *@
                                            @project.ProjectName
                                        </h3>
                                    </div>
                                    @* <div class="relative group">
                                        @{
                                            string borderColor =
                                            project.Progress == 0 ? "border-gray-500" :
                                            project.Progress < 25 ? "border-red-700" :
                                            project.Progress < 50 ? "border-yellow-400" :
                                            project.Progress < 75 ? "border-blue-400" :
                                            project.Progress < 100 ? "border-orange-400" :
                                            project.Progress == 100 ? "border-green-500" :
                                            "border-gray-500";

                                            string bgColor = project.Progress == 0 ? "bg-gray-500" :
                                            project.Progress < 25 ? "bg-red-700" :
                                            project.Progress < 50 ? "bg-yellow-400" :
                                            project.Progress < 75 ? "bg-blue-400" :
                                            project.Progress < 100 ? "bg-orange-400" :
                                            project.Progress == 100 ? "bg-green-500" : "bordbger-gray-500";
                                        }
                                        <div class="flex items-center gap-3 bg-gray-700 rounded-full px-2 py-1 w-fit border-[2px] @borderColor">
                                            <div class="bg-gray-600 rounded-full h-2 w-32 overflow-hidden">
                                                <div class="h-2 rounded-full @bgColor" style="width: @project.Progress%"></div>
                                            </div>
                                            <p class="text-gray-300 text-xs whitespace-nowrap">
                                                @project.Progress%
                                            </p>
                                        </div>
                                        <span class="absolute -left-1/2 -top-[-1px] -translate-x-[4.5rem] bg-gray-900 text-white text-xs rounded-md px-2 py-1 opacity-0 scale-90 group-hover:opacity-100 group-hover:scale-100 transition-all duration-200 whitespace-nowrap shadow-lg">
                                            Tiến độ hoàn thành dự án
                                        </span>
                                    </div> *@
                                </div>
                                <div class="mt-5 flex align-items-center gap-3">
                                    <div class="flex gap-1 items-center  bg-gray-700/50 px-4 py-1.5 rounded-full">
                                        <i data-lucide="circle-user-round" class="w-4 h-4 text-white"></i>
                                        <span class="text-xs">@(project.Manager?.FullName ?? "Unknown")</span>
                                    </div>

                                    <div class="flex gap-1 items-center  bg-green-900/50 px-4 py-1.5 rounded-full">
                                        <i data-lucide="calendar" class="w-4 h-4 text-white"></i>
                                        <span class="text-xs">
                                            @(project.StartDay.HasValue? project.StartDay.Value.ToString("dd/MM/yyyy") : "Chưa có ngày bắt đầu")
                                        </span>
                                    </div>

                                    <div class="flex gap-1 items-center  bg-red-900/50 px-4 py-1.5 rounded-full ">
                                        <i data-lucide="calendar-check" class="w-4 h-4 text-white"></i>
                                        <span class="text-xs">
                                            @(project.EndDay.HasValue? project.EndDay.Value.ToString("dd/MM/yyyy") : "Chưa có ngày bắt đầu")
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="project#@project.IdProject" class="max-h-[1000px] overflow-hidden transition-all duration-500 ease-in-out">
                            <div class="p-4 border-t border-gray-700 bg-gray-900/60">
                                <div class="mb-4 p-3 rounded-lg bg-gradient-to-r from-indigo-600/20 to-purple-600/10 border border-indigo-500/30">
                                    <div class="flex items-center justify-between mb-1">
                                        <h4 class="text-white text-sm font-semibold flex items-center gap-2">
                                            <i data-lucide="file-text" class="w-4 h-4 text-indigo-400"></i>
                                            Mô tả dự án
                                        </h4>
                                        <div class="flex items-center gap-2 relative">
                                            <!-- thêm relative để modal có reference -->
                                            @if (project.FileNote != null && !string.IsNullOrEmpty(project.FileNote))
                                            {
                                                <button class="flex items-center gap-2 text-xs text-indigo-300 bg-indigo-600/20 hover:bg-indigo-600/40 border border-indigo-400/40 rounded-lg px-3 py-1.5 transition-all"
                                                        onclick="downloadFile('@project.FileNote')">
                                                    <i data-lucide='download' class='w-3 h-3'></i>
                                                    Tải xuống
                                                </button>

                                                <button class="flex items-center gap-2 text-xs text-indigo-300 bg-indigo-600/20 hover:bg-indigo-600/40 border border-indigo-400/40 rounded-lg px-3 py-1.5 transition-all"
                                                        onclick="viewFile('@project.FileNote')">
                                                    <i data-lucide='eye' class='w-3 h-3'></i>
                                                    Xem
                                                </button>
                                            }

                                            <button id="addFileBtn#@project.IdProject" data-project="@project.IdProject" class="flex items-center gap-2 text-xs text-green-300 bg-green-600/20 hover:bg-green-600/40 border border-green-400/40 rounded-lg px-3 py-1.5 transition-all">
                                                <i data-lucide='plus' class='w-3 h-3'></i>
                                                Thêm file
                                            </button>
                                        </div>
                                    </div>

                                    <p class="text-gray-300 text-sm leading-relaxed">
                                        @* Xây dựng hệ thống báo cáo tự động hóa nội bộ. *@
                                        @project.Note
                                    </p>
                                </div>

                                <div class="max-h-[420px] overflow-y-auto overflow-x-hidden scroll-smooth custom-scroll">
                                    @* Task *@
                                    @if(project.Tasks != null)
                                    {
                                        @foreach (var task in project.Tasks)
                                        {
                                            @* if (task.ProjectId == project.IdProject) *@
                                            {
                                                string priorityBorder = "";
                                                switch (task.Priority?.ToString()?.ToLower())
                                                {
                                                    case "high":
                                                        priorityBorder = "border-red-900";//shadow-md shadow-red-500/50
                                                        break;
                                                    default:
                                                        priorityBorder = "border-gray-700";
                                                        break;
                                                }

                                                <div class="task-card border-l-[2px] @priorityBorder p-4 ml-[50px] rounded-bl-[10px] transition transform duration-300"
                                                     data-project-id="@project.IdProject"
                                                     data-priority="@task!.Priority!.ToString().ToLower()">
                                                    <div class="flex justify-between items-center">
                                                        <h2 class="font-semibold text-white text-sm">
                                                            @* Viết báo cáo *@
                                                            @task.NameTask
                                                        </h2>
                                                        <div class="relative group">
                                                            <button id="openUpdateTaskBtn#@project.IdProject#@task.IdTask"
                                                                    class="p-2 rounded-full bg-gray-800 hover:bg-indigo-600 transition-all shadow-md hover:shadow-lg"
                                                                    data-id="@task.IdTask"
                                                                    data-prjid="@project.IdProject"
                                                                    data-assid="@task.Assignee?.Id"
                                                                    data-name="@task.NameTask"
                                                                    data-assignee="@task.Assignee?.FullName"
                                                                    data-departId="@task.Assignee?.Department?.IdDepartment"
                                                                    data-depart="@task.Assignee?.Department!.DepartmentName"
                                                                    data-desc="@task.Note"
                                                                    data-start="@task.StartDate"
                                                                    data-end="@task.EndDate"
                                                                    data-status="@task.Status!.StatusId"
                                                                    data-prior="@task.Priority"
                                                                    data-fileurl="@task.FileNote">
                                                                    @* data-progress="@task.Progress" *@
                                                                    @* data-filename="@task.File!.Name" *@

                                                                <i data-lucide="bolt" class="w-4 h-4 text-gray-300"></i>
                                                            </button>
                                                            <span class="absolute z-20 left-1/2 -top-[-1px] -translate-x-[6.5rem] bg-gray-900 text-white text-xs rounded-md px-2 py-1 opacity-0 scale-90 group-hover:opacity-100 group-hover:scale-100 transition-all duration-200 whitespace-nowrap shadow-lg">
                                                                Xem chi tiết
                                                            </span>
                                                        </div>
                                                    </div>

                                                    <div class="flex items-center justify-between mb-6 mt-3 bg-gray-700/40 px-2 py-1 rounded-lg border border-gray-600">
                                                        <!-- Phần mô tả -->
                                                        <div class="flex items-start gap-2 max-w-[70%]">
                                                            <i data-lucide="info" class="w-5 h-5 text-indigo-400"></i>
                                                            <p class="text-indigo-300 text-xs leading-relaxed">
                                                                <span class="font-semibold text-white">Mô tả công việc: </span>
                                                                <span>
                                                                    @* Viết nội dung giới thiệu và dịch vụ cho website 33 *@
                                                                    @task.Note
                                                                </span>
                                                            </p>
                                                        </div>

                                                        <!-- Nhóm nút -->
                                                        <div class="flex items-center gap-2 relative">
                                                            <!-- thêm relative để modal có reference -->
                                                            <div class="relative group">
                                                                <button class="flex items-center gap-2 text-sm text-indigo-300 bg-indigo-600/20 hover:bg-indigo-600/40 border border-indigo-400/40 rounded-lg px-2 py-2 transition-all">
                                                                    <i data-lucide='paperclip' class='w-4 h-4'></i>
                                                                </button>
                                                                <div class="absolute -top-0 z-100 right-0 -translate-x-1/3 bg-gray-900 text-white text-xs rounded-md px-2 py-1 opacity-0 scale-90 group-hover:opacity-100 group-hover:scale-100 transition-all duration-200 whitespace-nowrap shadow-lg">
                                                                    <div class="flex justify-end gap-[10px] bg-gray-900">
                                                                        @* @if (task.File != null && !string.IsNullOrEmpty(task.File.Url))
                                                                        { *@
                                                                        <div class="relative group">
                                                                            <button class="flex items-center gap-2 text-xs text-indigo-300 bg-indigo-600/20 hover:bg-indigo-600/40 border border-indigo-400/40 rounded-lg px-3 py-1.5 transition-all"
                                                                                    onclick="downloadFile('@task.FileNote')"
                                                                                    @(task.FileNote == null || string.IsNullOrEmpty(task.FileNote) ? "disabled" : "")>
                                                                                <i data-lucide='download' class='w-3 h-3'></i>
                                                                            </button>
                                                                            <span class="absolute -bottom-8 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-xs rounded-md px-2 py-1 opacity-0 scale-90 group-hover:opacity-100 group-hover:scale-100 transition-all duration-200 whitespace-nowrap shadow-lg">
                                                                                Tải xuống
                                                                            </span>
                                                                        </div>

                                                                        <div class="relative group">
                                                                            <button class="flex items-center gap-2 text-xs text-indigo-300 bg-indigo-600/20 hover:bg-indigo-600/40 border border-indigo-400/40 rounded-lg px-3 py-1.5 transition-all"
                                                                                    onclick="viewFile('@task.FileNote')"
                                                                                    @(task.FileNote == null || string.IsNullOrEmpty(task.FileNote) ? "disabled" : "")>
                                                                                <i data-lucide='eye' class='w-3 h-3'></i>
                                                                            </button>
                                                                            <span class="absolute -bottom-8 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-xs rounded-md px-2 py-1 opacity-0 scale-90 group-hover:opacity-100 group-hover:scale-100 transition-all duration-200 whitespace-nowrap shadow-lg">
                                                                                Xem
                                                                            </span>
                                                                        </div>
                                                                        @* } *@

                                                                        @* <div class="relative group">
                                                                            <button id="addFileBtnTask#@project.IdProject#@task.IdTask" data-project="@task.IdTask"
                                                                                    class="flex items-center gap-2 text-sm text-green-300 bg-green-600/20 hover:bg-green-600/40 border border-green-400/40 rounded-lg px-3 py-1.5 transition-all">
                                                                                <i data-lucide='plus' class='w-3 h-3'></i>
                                                                            </button>
                                                                            <span class="absolute -bottom-8 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-xs rounded-md px-2 py-1 opacity-0 scale-90 group-hover:opacity-100 group-hover:scale-100 transition-all duration-200 whitespace-nowrap shadow-lg">
                                                                                Thêm file
                                                                            </span>
                                                                        </div> *@
                                                                    </div>

                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>


                                                    @* Info - Progress *@
                                                    <div class="flex flex-row justify-between items-center w-full">
                                                        <div class="flex justify-start gap-3 items-center text-sm text-gray-400">
                                                            @* Label status-prority*@
                                                            <div class="flex flex-wrap gap-2">
                                                                @{
                                                                    string statusText = "";
                                                                    string statusClass = "";


                                                                    // 🟢 Xác định trạng thái theo tiến độ
                                                                    switch (@task.Status?.StatusName.ToString().ToLower() ?? "")
                                                                    {
                                                                        case "todo":
                                                                            statusText = "CHƯA BẮT ĐẦU";
                                                                            statusClass = "bg-gray-700/40 text-gray-300 border-gray-600";
                                                                            break;
                                                                        case "inprogress":
                                                                            statusText = "ĐANG THỰC HIỆN";
                                                                            statusClass = task.Overdue
                                                                                ? "bg-red-900/40 text-white border-red-900"
                                                                                : "bg-blue-900/40 text-blue-400 border-blue-900";
                                                                            break;
                                                                        case "done":
                                                                            statusText = "HOÀN THÀNH";
                                                                            statusClass = task.Overdue
                                                                                ? "bg-red-900/40 text-white border-red-900"
                                                                                : "bg-green-900/40 text-green-400 border-green-900";
                                                                            break;
                                                                        default:
                                                                            if (task.Overdue)
                                                                            {
                                                                                statusText = "TRỄ HẠN";
                                                                                statusClass = "bg-red-900/40 text-red-400 border-red-600";
                                                                                break;
                                                                            }
                                                                            statusText = "KHÔNG XÁC ĐỊNH";
                                                                            statusClass = "bg-gray-900/40 text-gray-400 border-gray-600";
                                                                            break;
                                                                    }
                                                                }

                                                                <span class="px-4 inline-flex items-center rounded-full border text-[10px] @statusClass">@statusText</span>
                                                            </div>
                                                            <span class="text-gray-400">•</span>
                                                            <div class="relative group cursor-pointer text-xs">
                                                                <div class="flex gap-1 items-center">
                                                                    <i data-lucide="circle-user-round" class="w-4 h-4 text-white"></i>
                                                                    <span>@(task.Assignee?.FullName ?? "Unknown")</span>
                                                                </div>
                                                                <span class="absolute -top-7 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-xs rounded-md px-2 py-1 opacity-0 scale-90 group-hover:opacity-100 group-hover:scale-100 transition-all duration-200 whitespace-nowrap shadow-lg">
                                                                    Người thực hiện
                                                                </span>
                                                            </div>
                                                            <span class="text-gray-400">•</span>
                                                            <div class="relative group cursor-pointer text-xs">
                                                                <div class="flex gap-1 items-center">
                                                                    <i data-lucide="calendar" class="w-4 h-4 text-green-600"></i>
                                                                    <span class="">
                                                                        @(task.StartDate.HasValue? task.StartDate.Value.ToString("dd/MM/yyyy") : "--/--/----")
                                                                    </span>
                                                                </div>
                                                                <span class="absolute -top-7 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-xs rounded-md px-2 py-1 opacity-0 scale-90 group-hover:opacity-100 group-hover:scale-100 transition-all duration-200 whitespace-nowrap shadow-lg">
                                                                    Thời gian bắt đầu
                                                                </span>
                                                            </div>
                                                            <span class="text-gray-400">•</span>
                                                            <div class="relative group cursor-pointer text-xs">
                                                                <div class="flex gap-1 items-center">
                                                                    <i data-lucide="calendar-check" class="w-4 h-4 text-red-600"></i>
                                                                    <span>
                                                                        @(task.EndDate.HasValue? task.EndDate.Value.ToString("dd/MM/yyyy") : "--/--/----")
                                                                    </span>
                                                                </div>
                                                                <span class="absolute -top-7 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-xs rounded-md px-2 py-1 opacity-0 scale-90 group-hover:opacity-100 group-hover:scale-100 transition-all duration-200 whitespace-nowrap shadow-lg">
                                                                    Thời gian hết hạn
                                                                </span>
                                                            </div>
                                                        </div>

                                                        <div class="relative group">
                                                            <div class="flex items-center gap-4">
                                                                <div class="relative w-10 h-10  cursor-pointer group" @* data-progress="@task.Progress" *@>
                                                                    <svg class="w-10 h-10" viewBox="0 0 36 36">
                                                                        <!-- Vòng nền -->
                                                                        <path class="text-gray-800"
                                                                              stroke="currentColor"
                                                                              stroke-width="3"
                                                                              fill="none"
                                                                              d="M18 2.0845
                                                                                            a 15.9155 15.9155 0 0 1 0 31.831
                                                                                            a 15.9155 15.9155 0 0 1 0 -31.831" />
                                                                        <!-- Vòng tiến độ -->
                                                                        <path class="progress-ring text-blue-500"
                                                                              stroke="currentColor"
                                                                              stroke-width="2"
                                                                              stroke-linecap="round"
                                                                              fill="none"
                                                                              d="M18 2.0845
                                                                                            a 15.9155 15.9155 0 0 1 0 31.831
                                                                                            a 15.9155 15.9155 0 0 1 0 -31.831" />
                                                                    </svg>
                                                                    <span class="absolute inset-0 flex items-center justify-center text-xs text-gray-200 font-semibold">
                                                                        0%
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <span class="absolute left-1/2 top-[8px] -translate-x-[9rem] bg-gray-900 text-white text-xs rounded-md px-2 py-1 opacity-0 scale-90 group-hover:opacity-100 group-hover:scale-100 transition-all duration-200 whitespace-nowrap shadow-lg">
                                                                Tiến độ hoàn thành
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>    
                                            }
                                        }
                                    }
                                    else
                                    {
                                        <div class="text-center py-10 text-gray-400 text-lg bg-gray-900/50 rounded-lg flex flex-col items-center justify-center gap-3">
                                            <i data-lucide="folder-x" class="w-[80px] h-[80px] text-gray-500"></i>
                                            <span>Hiện chưa có nhiệm vụ nào.</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>

    <!-- CỘT PHẢI -->
    <div class="space-y-6">
        <!-- Chart 1 -->
        <div class="bg-gradient-to-b from-gray-900 to-gray-800 rounded-2xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-white mb-4" id="TaskStatusProgress">Trạng thái nhiệm vụ</h3>
            <canvas id="statusChart" height="200"></canvas>
        </div>

        <!-- Chart 2 -->
        <div class="bg-gradient-to-b from-gray-900 to-gray-800 rounded-2xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Phân bố tiến độ dự án</h3>
            <canvas id="progressChart" height="200"></canvas>
        </div>
    </div>
</div>

@* ============================================================================ *@
@section GlobalModals{
    <!-- Overlay tối nền -->
    <div id="uploadOverlay" class="fixed inset-0 bg-black/80 hidden z-40"></div>
    <!-- Overlay Loading -->
    <div id="loadingOverlay"
         class="hidden fixed inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center z-[9999] backdrop-blur-sm">
        <div class="flex flex-col items-center">
            <!-- Vòng xoay -->
            <div class="w-14 h-14 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
            <!-- Chữ -->
            <p class="mt-4 text-white text-lg font-medium tracking-wide animate-pulse">
                Đang xử lý, vui lòng chờ...
            </p>
        </div>
    </div>
    <!-- Modal chính giữa -->
    <div id="uploadModal" class="fixed inset-0 flex items-center justify-center hidden z-50">
        <div class="w-[650px] bg-gray-900 rounded-xl border border-gray-700 shadow-[0_0_60px_rgba(0,0,0,0.8)] p-7 relative">
            <!-- Nút đóng -->
            <button onclick="closeUploadModal()" class="absolute top-3 right-3 text-gray-400 hover:text-white transition">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <!-- Tiêu đề -->
            <h3 class="text-xl font-semibold text-white mb-6 flex items-center gap-2">
                <i data-lucide="file-plus" class="w-5 h-5 text-indigo-400"></i>
                Thêm File
            </h3>

            <!-- Hai cột -->
            <div class="flex gap-6">
                <!-- Cột trái: Upload -->
                <form id="uploadForm" class="flex flex-col gap-4 w-1/2">
                    <!-- Vùng chọn file -->
                    <label id="dropZone" for="fileInput"
                           class="cursor-pointer flex flex-col items-center justify-center gap-3 p-6 border-2 border-dashed border-indigo-500 rounded-lg hover:bg-indigo-600/10 transition-all text-center text-indigo-300">
                        <i data-lucide="upload" class="w-7 h-7 text-indigo-400"></i>
                        <span class="font-medium text-white">Nhấp hoặc kéo tệp vào đây</span>
                        <span class="text-xs text-indigo-300">Hỗ trợ: PDF, DOC, DOCX, PNG, JPG, JPEG</span>
                    </label>

                    <input type="file" id="fileInput" class="hidden" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg,.xls,.xlsx" />

                    <!-- Tên file -->
                    <p id="fileName" class="text-sm text-indigo-300"></p>

                    <!-- Nút Upload -->
                    <button type="submit"
                            class="mt-3 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white font-medium shadow-md transition-all">
                        Tải lên
                    </button>
                </form>

                <!-- Cột phải: Preview -->
                <div id="previewContainer"
                     class="w-1/2 rounded-lg border border-gray-700 p-3 bg-gray-800 max-h-[300px] overflow-auto text-white flex items-center justify-center">
                    <p class="text-gray-400 text-sm text-center">Preview File</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal form add/update task -->
    <div id="updateTaskModal" class="fixed inset-0 flex items-center justify-center hidden z-50 overflow-hidden">
        <div class="bg-gray-900 w-[700px] rounded-2xl shadow-[0_0_100px_rgba(0,0,0,0.8)] border border-gray-700 relative animate-fadeIn max-h-[83vh] flex flex-col">
            <!-- Header cố định -->
            <div class="sticky top-0 bg-gray-900 z-10 px-8 pt-6 pb-4 border-b border-gray-800 flex justify-between items-center rounded-tl-2xl rounded-tr-2xl">
                <h3 class="text-xl font-semibold text-white flex items-center gap-2">
                    <i data-lucide="edit-3" class="w-6 h-6 text-indigo-400"></i>
                    Nhiệm vụ
                </h3>
                <button id="closeUpdateTaskBtn"
                        class="text-gray-400 hover:text-white transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Nội dung cuộn -->
            <div class="px-8 pb-8 overflow-y-auto custom-scroll">
                <form id="updateTaskForm" class="flex flex-col gap-6 mt-4">
                    <!-- Tên nhiệm vụ -->
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1">
                            <label class="block text-xs text-gray-300 mb-2">Tên nhiệm vụ</label>
                            <input id="taskName"
                                   type="text"
                                   class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white text-xs focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                                   placeholder="Nhập tên task..." />
                        </div>

                        <div class="flex-1">
                            <label class="block text-xs text-gray-300 mb-2 font-medium">Dự án</label>
                            <div id="projectOptions" class="relative group ">
                                <select id="project" disabled
                                        class="appearance-none w-full px-4 text-xs py-2 rounded-lg bg-gray-800/80 border border-gray-700 text-gray-200 font-medium focus:ring-2 focus:ring-indigo-500 outline-none transition-all hover:bg-gray-800/90 cursor-pointer">
                                    <option value="">---Chọn dự án---</option>
                                    @if (Model.Projects != null && Model.Projects.Any())
                                    {
                                        @foreach (var p in Model.Projects)
                                        {
                                            <option value="@p.IdProject">@p.ProjectName</option>
                                        }
                                    }
                                </select>
                                <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-gray-400">
                                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Người nhận -->
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1">
                            <label class="block text-xs text-gray-300 mb-2 font-medium">Phòng ban</label>
                            <div id="departmentOptions" class="relative group ">
                                <select id="department"
                                        class="appearance-none w-full px-4 text-xs py-2 rounded-lg bg-gray-800/80 border border-gray-700 text-gray-200 font-medium focus:ring-2 focus:ring-indigo-500 outline-none transition-all hover:bg-gray-800/90 cursor-pointer">
                                    <option value="">---Chọn phòng ban---</option>
                                    @if(Model.Departments != null && Model.Departments.Any())
                                    {
                                        @foreach (var d in Model.Departments)
                                        {
                                            <option value="@d.IdDepartment">@d.DepartmentName</option>
                                        }    
                                    }
                                </select>
                                <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-gray-400">
                                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex-1">
                            <label class="block text-xs text-gray-300 mb-2">Người nhận nhiệm vụ</label>
                            <input id="taskAssignee"
                                   type="text"
                                   disabled
                                   class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white text-xs focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                                   placeholder="Nhập tên người nhận..." />
                            <input type="hidden" id="taskAssigneeId" name="taskAssigneeId">
                            <!-- Danh sách gợi ý user -->
                            <ul id="userSuggestions"
                                class="absolute z-50 mt-1 bg-gray-800 border border-gray-700 rounded-lg shadow-lg text-white text-sm hidden
                                       max-h-40 overflow-y-auto scrollbar-thin scrollbar-thumb-indigo-600 scrollbar-track-gray-700">
                            </ul>

                        </div>
                    </div>

                    <!-- Mô tả -->
                    <div>
                        <label class="block text-xs text-gray-300 mb-2">Mô tả</label>
                        <textarea id="taskDesc"
                              rows="4"
                              class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white text-xs focus:ring-2 focus:ring-indigo-500 focus:outline-none resize-none"
                              placeholder="Nhập mô tả..."></textarea>
                    </div>

                    <!-- Ngày bắt đầu / Ngày kết thúc -->
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1 relative">
                            <label class="block text-xs text-gray-300 mb-1">Ngày bắt đầu</label>
                            <input id="taskStart"
                                   type="date"
                                   class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white text-xs focus:ring-2 focus:ring-indigo-500 focus:outline-none appearance-none pr-10" />
                            <i data-lucide="calendar"
                               class="absolute cursor-pointer right-10 top-7 text-gray-400 pointer-events-none w-4 h-4"></i>
                        </div>

                        <div class="flex-1 relative">
                            <label class="block text-xs text-gray-300 mb-1">Ngày kết thúc</label>
                            <input id="taskEnd"
                                   type="date"
                                   class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white text-xs focus:ring-2 focus:ring-indigo-500 focus:outline-none appearance-none pr-10" />
                            <i data-lucide="calendar"
                               class="absolute cursor-pointer right-10 top-7 text-gray-400 pointer-events-none w-4 h-4"></i>
                        </div>
                    </div>

                    <!-- Trạng thái & Ưu tiên -->
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1">
                            <label class="block text-xs text-gray-300 mb-2 font-medium">Trạng thái</label>
                            <div class="relative group">
                                <select id="taskStatus"
                                        class="appearance-none w-full px-4 text-xs py-2.5 rounded-xl bg-gray-800/80 border border-gray-700 text-gray-200 font-medium focus:ring-2 focus:ring-indigo-500 outline-none transition-all hover:bg-gray-800/90 cursor-pointer">
                                    <option value="status-todo">Chưa bắt đầu</option>
                                    <option value="status-inprogress">Đang thực hiện</option>
                                    <option value="status-done">Hoàn thành</option>
                                </select>
                                <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-gray-400">
                                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                </div>
                            </div>
                        </div>

                        <div class="flex-1">
                            <label class="block text-xs text-gray-300 mb-2 font-medium">Độ ưu tiên</label>
                            <div class="relative group">
                                <select id="taskPriority"
                                        class="appearance-none w-full px-4 text-xs py-2.5 rounded-xl bg-gray-800/80 border border-gray-700 text-gray-200 font-medium focus:ring-2 focus:ring-indigo-500 outline-none transition-all hover:bg-gray-800/90 cursor-pointer">
                                    <option value="low">Thấp</option>
                                    <option value="medium">Trung bình</option>
                                    <option value="high">Cao</option>
                                </select>
                                <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-gray-400">
                                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Upload + Preview -->
                    <div class="flex flex-col gap-3">
                        <label class="text-xs text-gray-300 font-medium">Tệp đính kèm</label>
                        <div class="flex flex-col sm:flex-row gap-4 items-stretch">
                            <div class="flex flex-col w-full sm:w-1/3">
                                <label id="dropZone"
                                       for="fileInputEdit"
                                       class="cursor-pointer flex flex-col items-center justify-center gap-3 flex-1 p-6 border-2 border-dashed border-indigo-500 rounded-lg hover:bg-indigo-600/10 transition-all text-center text-indigo-300">
                                    <i data-lucide="upload" class="w-7 h-7 text-indigo-400"></i>
                                    <span class="font-medium text-white text-xs">Chọn để thêm tệp</span>
                                    <span class="text-xs text-indigo-300">PDF, DOCX, XLSX, PNG...</span>
                                </label>
                                <input type="file"
                                       id="fileInputEdit"
                                       class="hidden"
                                       accept=".pdf,.doc,.docx,.png,.jpg,.jpeg,.xls,.xlsx" />
                                <!-- Hidden input để giữ file cũ -->
                                <input type="hidden" id="existingFileUrl" name="existingFileUrl" />
                                <p id="fileNameEdit"
                                   class="text-sm text-indigo-300 mt-1 truncate overflow-hidden text-ellipsis whitespace-nowrap flex items-center justify-start w-full"></p>
                            </div>

                            <div id="previewContainerEdit"
                                 class="w-full sm:w-2/3 rounded-[10px] border border-indigo-700 overflow-hidden p-6 bg-gray-800 max-h-[200px] overflow-auto text-white flex items-center justify-center">
                                <p class="text-gray-400 text-sm text-center">Preview File</p>
                            </div>
                        </div>
                    </div>

                    <!-- Nút submit -->
                    <div class="flex justify-end mt-4 gap-2">
                        <button id="deleteBtn" type="button"
                                class="px-8 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-white text-xs font-medium shadow-md transition-all">
                            Xóa
                        </button>
                        <button type="submit"
                                class="px-5 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white text-xs font-medium shadow-md transition-all">
                            Xác nhận
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal form add/update Project -->
    <div id="updateProjectModal" class="fixed inset-0 flex items-center justify-center hidden z-50 ">
        <div class="bg-gray-900 w-[1000px] p-8 rounded-2xl shadow-[0_0_100px_rgba(0,0,0,0.8)] border border-gray-700 relative animate-fadeIn max-h-[85vh] overflow-y-auto">

            <!-- Nút đóng -->
            <button id="closeUpdateProjectBtn" class="absolute top-3 right-3 text-gray-400 hover:text-white transition">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <h3 class="text-xl font-semibold text-white mb-6 flex items-center gap-2">
                <i data-lucide="edit-3" class="w-6 h-6 text-indigo-400"></i>
                Dự án
            </h3>

            <form id="updateProjectForm" class="grid grid-cols-2 gap-6">
                <!-- Cột trái -->
                <div class="flex flex-col gap-4">
                    <div>
                        <label class="block text-xs text-gray-300 mb-1">Tên nhiệm vụ</label>
                        <input id="projectName" type="text"
                               class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white text-xs focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                               placeholder="Nhập tên project..." />
                    </div>

                    <div>
                        <label class="block text-xs text-gray-300 mb-1">Người nhận nhiệm vụ</label>
                        <input id="projectAssignee" type="text"
                               class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white text-xs focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                               placeholder="Nhập tên người quản lý..." />
                    </div>

                    <div>
                        <label class="block text-xs text-gray-300 mb-1">Mô tả</label>
                        <textarea id="projectDesc" rows="5"
                              class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white text-xs focus:ring-2 focus:ring-indigo-500 focus:outline-none resize-none"
                              placeholder="Nhập mô tả..."></textarea>
                    </div>
                </div>

                <!-- Cột phải -->
                <div class="flex flex-col gap-4">
                    <div class="flex gap-4">
                        <div class="flex-1 relative">
                            <label class="block text-xs text-gray-300 mb-1">Ngày bắt đầu</label>
                            <input id="projectStart" type="date"
                                   class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white text-xs focus:ring-2 focus:ring-indigo-500 focus:outline-none appearance-none pr-10" />
                            <i data-lucide="calendar" class="absolute right-10 top-8 text-gray-400 pointer-events-none w-4 h-4"></i>
                        </div>

                        <div class="flex-1 relative">
                            <label class="block text-xs text-gray-300 mb-1">Ngày kết thúc</label>
                            <input id="projectEnd" type="date"
                                   class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white text-xs focus:ring-2 focus:ring-indigo-500 focus:outline-none appearance-none pr-10" />
                            <i data-lucide="calendar" class="absolute right-10 top-8 text-gray-400 pointer-events-none w-4 h-4"></i>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <!-- Trạng thái -->
                        <div class="flex-1">
                            <label class="block text-xs text-gray-300 mb-2 font-medium">Trạng thái</label>
                            <div class="relative group">
                                <select id="projectStatus"
                                        class="appearance-none w-full px-4 text-xs py-2.5 rounded-xl bg-gray-800/80 border border-gray-700 text-gray-200 font-medium focus:ring-2 focus:ring-indigo-500 outline-none transition-all hover:bg-gray-800/90 cursor-pointer">
                                    <option>Chưa bắt đầu</option>
                                    <option>Đang thực hiện</option>
                                    <option>Hoàn thành</option>
                                    <option>Trễ hạn</option>
                                </select>
                                <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-gray-400">
                                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Upload + Preview -->
                    <div class="flex gap-4 items-stretch">
                        <div class="flex flex-col w-1/3">
                            <label id="dropZoneProject" for="fileInputEditProject"
                                   class="cursor-pointer flex flex-col items-center justify-center gap-3 flex-1 p-6 border-2 border-dashed border-indigo-500 rounded-lg hover:bg-indigo-600/10 transition-all text-center text-indigo-300">
                                <i data-lucide="upload" class="w-7 h-7 text-indigo-400"></i>
                                <span class="font-medium text-white text-xs">Chọn để thêm tệp</span>
                                <span class="text-xs text-indigo-300">PDF, DOCX, XLSX, PNG...</span>
                            </label>
                            <input type="file" id="fileInputEditProject" class="hidden" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg,.xls,.xlsx" />

                            <p id="fileNameEditProject"
                               class="text-sm text-indigo-300 mt-1 truncate overflow-hidden text-ellipsis whitespace-nowrap flex items-center justify-start w-48">
                            </p>
                        </div>

                        <div id="previewContainerEditProject"
                             class="w-2/3 rounded-[10px] border border-indigo-700 overflow-hidden p-6 bg-gray-800 max-h-[200px] h-[200px] overflow-auto text-white flex items-center justify-center">
                            <p class="text-gray-400 text-sm text-center">Preview File</p>
                        </div>
                    </div>

                    <!-- Nút submit -->
                    <div class="flex justify-end mt-4">
                        <button type="submit"
                                class="px-5 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white text-xs font-medium shadow-md transition-all">
                            Xác nhận
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
}
@* ============================================================================ *@


@section Scripts{
    <script>
        document.addEventListener("DOMContentLoaded", () => {
          lucide.createIcons();

          // 🔹 Chờ Razor render xong rồi mới gắn event
          setTimeout(() => {
            const toggleButtons = document.querySelectorAll("[data-toggle]");

            toggleButtons.forEach(btn => {
              const targetId = btn.getAttribute("data-toggle");
              const content = document.getElementById(targetId);
              const icon = btn.querySelector("svg");

              // Mặc định mở tất cả
              content.classList.remove("max-h-0");
              content.classList.add("max-h-[1000px]");
              btn.classList.add("open");

              btn.addEventListener("click", () => {
                const isOpen = btn.classList.contains("open");

                if (isOpen) {
                  content.classList.remove("max-h-[1000px]");
                  content.classList.add("max-h-0");
                  btn.classList.remove("open");
                } else {
                  content.classList.remove("max-h-0");
                  content.classList.add("max-h-[1000px]");
                  btn.classList.add("open");
                }

                if (icon) {
                  icon.style.transform = isOpen ? "rotate(0deg)" : "rotate(180deg)";
                  icon.style.transition = "transform 0.3s ease";
                }
              });
            });

            // 🔹 Nút "Thu gọn / Mở tất cả"
            const toggleAllBtn = document.getElementById("toggleAllBtn");
            let allOpen = true;

            toggleAllBtn.addEventListener("click", () => {
              toggleButtons.forEach(btn => {
                const targetId = btn.getAttribute("data-toggle");
                const content = document.getElementById(targetId);
                const icon = btn.querySelector("svg");

                if (allOpen) {
                  content.classList.remove("max-h-[1000px]");
                  content.classList.add("max-h-0");
                  btn.classList.remove("open");
                  if (icon) icon.style.transform = "rotate(0deg)";
                } else {
                  content.classList.remove("max-h-0");
                  content.classList.add("max-h-[1000px]");
                  btn.classList.add("open");
                  if (icon) icon.style.transform = "rotate(180deg)";
                }
              });

              allOpen = !allOpen;
              toggleAllBtn.innerHTML = allOpen
                ? `<i data-lucide="chevron-up" class="w-4 h-4"></i> <span class="text-xs">Thu gọn tất cả</span>`
                : `<i data-lucide="chevron-down" class="w-4 h-4"></i> <span class="text-xs">Mở tất cả</span>`;

              lucide.createIcons();
            });
          }, 100); // ⏳ chờ DOM của Razor render xong
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

    @* Log *@
    <script>
        const projects0 = JSON.parse('@Html.Raw(ViewBag.ProjectsJson)');
        console.log("Dữ liệu từ SQL:", projects0);
        const users = JSON.parse('@Html.Raw(ViewBag.DepartmentsJson)');
        console.log("Data: ", users);
    </script>

    @* Department - User *@
    <script>
        const department = JSON.parse('@Html.Raw(ViewBag.DepartmentsJson)');

        const departmentSelect = document.getElementById("department");
        const assigneeInput = document.getElementById("taskAssignee");
        const suggestionList = document.getElementById("userSuggestions");

        @* departmentSelect.innerHTML = '<option value="">---Chọn phòng ban---</option>';
        department.forEach(dep => {
            const opt = document.createElement("option");
            opt.value = dep.IdDepartment;
            opt.textContent = dep.DepartmentName;
            departmentSelect.appendChild(opt);
        }); *@

        let currentDeptUsers = [];

        // --- Khi chọn phòng ban ---
        departmentSelect.addEventListener("change", () => {
            const selected = departmentSelect.value;
            assigneeInput.value = ""; // xóa dữ liệu cũ
            console.log(assigneeInput.value);

            if (selected) {
                const dept = department.find(d => d.IdDepartment == selected);
                currentDeptUsers = dept?.Users || [];

                assigneeInput.disabled = false;
                assigneeInput.placeholder = "Nhập # để chọn người nhận...";
                assigneeInput.classList.remove("bg-gray-700");
                assigneeInput.classList.add("bg-gray-800");
            } else {
                currentDeptUsers = [];
                assigneeInput.disabled = true;
                assigneeInput.placeholder = "Chọn phòng ban trước...";
                suggestionList.classList.add("hidden");
            }
        });

        // --- Khi gõ vào ô người nhận ---
        assigneeInput.addEventListener("input", (e) => {
            let text = e.target.value;

            // Nếu người dùng không bắt đầu bằng '#', tự động thêm #
            if (text.length > 0 && !text.startsWith("#")) {
                text = "#" + text.replace(/#/g, ""); // loại bỏ # dư thừa giữa chuỗi
                assigneeInput.value = text;
                console.log(assigneeInput.value);
            }

            // Chỉ xử lý nếu có phòng ban
            if (!departmentSelect.value) {
                suggestionList.classList.add("hidden");
                return;
            }

            // Bắt buộc có ký tự # đầu tiên mới hiển thị list
            if (!text.startsWith("#")) {
                suggestionList.classList.add("hidden");
                return;
            }

            const query = text.slice(1).trim().toLowerCase(); // bỏ dấu #
            suggestionList.innerHTML = "";

            if (currentDeptUsers.length === 0) {
                suggestionList.classList.add("hidden");
                return;
            }

            // Nếu chưa gõ gì sau # thì hiển thị toàn bộ
            const filteredUsers = query.length === 0
                ? currentDeptUsers
                : currentDeptUsers.filter(u => u.FullName.toLowerCase().includes(query));

            if (filteredUsers.length === 0) {
                const li = document.createElement("li");
                li.textContent = "Không tìm thấy người dùng";
                li.className = "px-3 py-2 text-gray-400 italic";
                suggestionList.appendChild(li);
            } else {
                console.log(filteredUsers);
                filteredUsers.forEach(u => {
                    const li = document.createElement("li");
                    li.textContent = u.FullName;
                    li.className = "px-3 py-1 hover:bg-indigo-600 hover:text-white cursor-pointer";
                    li.addEventListener("click", () => {
                        assigneeInput.value = "#" + u.FullName + " ";

                        // Gán ID người nhận vào hidden input
                        document.getElementById("taskAssigneeId").value = u.Id;
                        console.log(u.Id);
                        console.log(document.getElementById("taskAssigneeId").value);

                        suggestionList.classList.add("hidden");
                    });
                    suggestionList.appendChild(li);
                });
            }

            suggestionList.classList.remove("hidden");

            console.log(assigneeInput.value);
        });

        // --- Ẩn danh sách khi click ra ngoài ---
        document.addEventListener("click", (e) => {
            if (!assigneeInput.contains(e.target) && !suggestionList.contains(e.target)) {
                suggestionList.classList.add("hidden");
                suggestionList.innerHTML = ""; // clear nội dung
            }
        });
    </script>
    @* Search *@
    <script>
        document.getElementById("searchInput").addEventListener("input", function () {
            const keyword = this.value.toLowerCase();
            document.querySelectorAll(".task-card").forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(keyword) ? "block" : "none";
            });
        });
    </script>

    @* Card *@
    <script>
        const projects = JSON.parse('@Html.Raw(ViewBag.ProjectsJson)');

        // Lấy Id elements
        const tongduan = document.getElementById("tongduan");
        const duanhoanthanh = document.getElementById("duanhoanthanh");
        const duanhoanthanhpro = document.getElementById("duanhoanthanhpro");
         
        const tongnhiemvu = document.getElementById("tongnhiemvu");
        const nhiemvuhoanthanh = document.getElementById("nhiemvuhoanthanh");
        const nhiemvuhoanthanhpro = document.getElementById("nhiemvuhoanthanhpro");

        const nhiemvudanglam = document.getElementById("nhiemvudanglam");
        const nhiemvuchuabd = document.getElementById("nhiemvuchuabd");

        const nhiemvuquahan = document.getElementById("nhiemvuquahan");
        const nhiemvuquahanpro = document.getElementById("nhiemvuquahanpro");

        //Xử lý dữ liệu
        let countProject = 0;
        let countProjectDone = 0;
        let countTask = 0;
        let countTaskDone = 0;
        let countTaskInProgress = 0;
        let countTaskTodo = 0;
        let countTaskOverDue = 0;

        projects.forEach(p => {
            countProject++;
            if(p.Status.StatusName == 3){
                countProjectDone++;
            }

            if(p.Tasks != null){
                p.Tasks.forEach(t => {
                    countTask++;
                    if(t.Status?.StatusName == 3) {
                        countTaskDone++;
                    }
                    if (t.Status?.StatusName == 2){
                        countTaskInProgress++;
                    }
                    if(t.Status?.StatusName == 1){
                        countTaskTodo++;
                    }
                    if (new Date(t.EndDate) < new Date() || t.Overdue) {
                        countTaskOverDue++;
                    }
                });
            }
        });

        let propt = null;
        // Gán dữ liệu
        tongduan.textContent = `${countProject}`;
        duanhoanthanh.textContent = `${countProjectDone}`;
        propt = countProject == 0? 0 : (countProjectDone / countProject) * 100;
        duanhoanthanhpro.textContent = `${propt.toFixed(2)}%`;

        tongnhiemvu.textContent = `${countTask}`;
        nhiemvuhoanthanh.textContent = `${countTaskDone}`;
        propt = countTask == 0 ? 0 : (countTaskDone / countTask) * 100;
        nhiemvuhoanthanhpro.textContent = `${propt.toFixed(2)}%`;

        nhiemvudanglam.textContent = `${countTaskInProgress}`;
        nhiemvuchuabd.textContent = `${countTaskTodo}`;

        nhiemvuquahan.textContent = `${countTaskOverDue}`;
        propt = countTask == 0 ? 0 : (countTaskOverDue / countTask) * 100;
        nhiemvuquahanpro.textContent = `${propt.toFixed(2)}`;
    </script>

    @* Filter High Priority*@
    <script>
        document.addEventListener("DOMContentLoaded", function () {
          const checkbox = document.getElementById("priorityHigh");
          const taskCards = document.querySelectorAll(".task-card");

          checkbox.addEventListener("change", function () {
            const showHighOnly = checkbox.checked;

            taskCards.forEach(card => {
              const priority = card.dataset.priority?.toLowerCase();
              const isHigh = (priority === "cao" || priority === "high");

              if (showHighOnly && !isHigh) {
                card.classList.add("hidden-task");
                setTimeout(() => (card.style.display = "none"), 300);
              } else {
                card.style.display = "block";
                setTimeout(() => card.classList.remove("hidden-task"), 10);
              }
            });
          });
        });
    </script>

    @* Chart *@
    <script>
        lucide.createIcons();
        // 🔹 Lấy dữ liệu từ Model C# sang JS
        const projects1 = JSON.parse('@Html.Raw(ViewBag.ProjectsJson)');
        console.log(projects1);
        // 🔹 Biến đếm trạng thái
        let notStarted = 0;
        let inProgress = 0;
        let completed = 0;
        let overdue = 0;
        let qtt = 0;

        // 🔹 Tính theo logic bạn đưa ra
        projects1.forEach(p => {
            const progress = p.Status.StatusName || 0;
            const endDate = new Date(p.EndDate);
            const now = new Date();
            qtt++;

            if (progress === 1) {
                notStarted++;
            } else if (progress === 2) {
                inProgress++;
            } else if (progress === 3) {
                completed++;
            }

            // Quá hạn: chưa hoàn thành & endDate < hiện tại
            if (progress === 3 && endDate < now) {
                overdue++;
            }
        });

        // Biểu đồ donut (trạng thái nhiệm vụ)
        const ctx1 = document.getElementById("statusChart").getContext("2d");
        new Chart(ctx1, {
          type: "doughnut",
          data: {
            labels: ["Chưa triển khai", "Đang thực hiện", "Hoàn thành", "Quá hạn"],
            datasets: [
              {
                data: [notStarted, inProgress, completed, overdue],
                backgroundColor: ["#333", "#3b82f6", "#22c55e", "#ef4444"],
                borderWidth: 0,
              },
            ],
          },
          options: {
            cutout: "50%",
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  color: "#d1d5db",
                  boxWidth: 12,
                  padding: 15,
                },
              },
              datalabels: {
                color: "#fff",
                font: {
                  size: 14,
                  weight: "bold",
                },
                formatter: (value, ctx) => {
                  const dataArr = ctx.chart.data.datasets[0].data;
                  const sum = dataArr.reduce((a, b) => a + b, 0);

                  // ✅ Nếu tổng = 0 → không hiển thị %
                  if (sum === 0 || value === 0) return "";
                  const percentage = ((value / sum) * 100).toFixed(1) + "%";
                  return percentage;
                },
              },
            },
          },
          plugins: [
            ChartDataLabels,
            {
              id: "centerText",
              beforeDraw: (chart) => {
                const { width, height, ctx } = chart;
                ctx.restore();
                const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);

                ctx.font = "bold 16px sans-serif";
                ctx.fillStyle = "#e5e7eb";
                ctx.textBaseline = "middle";
                ctx.textAlign = "center";

                const content = document.getElementById("TaskStatusProgress");

                // ✅ Nếu tất cả bằng 0 → hiện chữ khác
                if (total === 0) {
                  ctx.fillText("Không có dữ liệu", width / 2, height / 2.2);
                }
                else {
                  // ctx.fillText(`Tổng số: ${qtt}`, width / 2, height / 2.2);
                }
                content.textContent = `Trạng thái nhiệm vụ`;
                ctx.save();
              },
            },
          ],
        });

        // Biểu đồ cột (phân bố tiến độ)
        // Biểu đồ cột (phân bố tiến độ theo số lượng dự án)
        // Đếm số lượng dự án theo khoảng tiến độ
        let countToDo = 0;
        let countInProgress = 0;
        let countInDone = 0;
        let countOverdue = 0;

        projects1.forEach(p => {
            const progress = p.Status.StatusName || 0;
            const endDate = new Date(p.EndDay);
            console.log(p.EndDay);
            const now = new Date();

            if (endDate < now && progress !== 3)
            {
                countOverdue++;
            }
            else
            {
                if(progress === 1)
                {
                    countToDo++;
                }
                else if(progress === 2)
                {
                    countInProgress++;
                } 
                else if (progress === 3)
                {
                    countInDone++;
                } 
            }
        });
        const ctx2 = document.getElementById("progressChart").getContext("2d");
        new Chart(ctx2, {
          type: "bar",
          data: {
            labels: ["ToDo", "InProgress", "Done", "Overdue"],
            datasets: [{
              label: "Số lượng dự án",
              data: [
                countToDo,
                countInProgress,
                countInDone,
                countOverdue,
              ], // 👉 thay bằng dữ liệu thật
              backgroundColor: [
                "#eab308", // 50%-75% → vàng
                "#3b82f6", // 75%-99% → xanh lá
                "#22c55e",  // 100% → xanh dương
                "#ef4444", // 0%-25% → đỏ
              ],
              borderRadius: 6,
            }]
          },
          options: {
            indexAxis: "x",
            scales: {
              x: {
                title: { display: true, text: "Trạng thái", color: "#d1d5db" },
                ticks: { color: "#9ca3af" },
                grid: { color: "#1f2937" },
              },
              y: {
                title: { display: true, text: "Số lượng dự án", color: "#d1d5db" },
                ticks: { color: "#9ca3af", stepSize: 1 },
                grid: { color: "#1f2937" },
                beginAtZero: true
              }
            },
            plugins: {
              legend: { labels: { color: "#d1d5db" } },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return ` ${context.dataset.label}: ${context.formattedValue}`;
                  }
                }
              }
            },
          },
        });
    </script>

    <script>
        window.onerror = function (message, source, lineno, colno, error) {
            console.error("⚠️ Lỗi runtime:", message, "Tại:", source, "Dòng:", lineno);
            alert("Đã xảy ra lỗi! Kiểm tra console để xem chi tiết.");
        };


        const fileUrl = "/resources/Báo cáo tuần 9.pdf";
        const fileName = "Báo cáo tuần 9.pdf";

        // 🔹 Modal Upload
        const uploadModal = document.getElementById(`uploadModal`);
        const uploadOverlay = document.getElementById(`uploadOverlay`);
        const dropZone = document.getElementById(`dropZone`);
        const dropZoneProject = document.getElementById(`dropZoneProject`);
        const fileInput = document.getElementById(`fileInput`);
        const previewContainer = document.getElementById(`previewContainer`);
        const fileNameEl = document.getElementById(`fileName`);
        const uploadForm = document.getElementById(`uploadForm`);

        // Modal Update
        const updateTaskModal = document.getElementById("updateTaskModal");
        const updateProjectModal = document.getElementById("updateProjectModal");
        const closeUpdateTaskBtn = document.getElementById("closeUpdateTaskBtn");
        const updateTaskForm = document.getElementById("updateTaskForm");
        const fileInputEdit = document.getElementById("fileInputEdit");
        const fileInputEditProject = document.getElementById("fileInputEditProject");
        const fileNameEditProject = document.getElementById("fileNameEditProject");
        const previewContainerEditProject = document.getElementById("previewContainerEditProject");
        const fileNameElEdit = document.getElementById("fileNameEdit");
        const previewElEdit = document.getElementById("previewContainerEdit");

        let currentContext = {};

        // --- HÀM MỞ/ĐÓNG MODAL UPLOAD ---
        function openUploadModal(projectId, taskId = null) {
            currentContext = { projectId, taskId }; // Lưu lại i và j (nếu có)
            uploadModal.classList.remove("hidden");
            uploadOverlay.classList.remove("hidden");
        }

        // Gán hàm này cho window để HTML `onclick` có thể gọi
        window.closeUploadModal = function() {
            uploadModal.classList.add("hidden");
            uploadOverlay.classList.add("hidden");

            // Reset form
            uploadForm.reset();
            fileNameEl.textContent = "";
            previewContainer.innerHTML = `<p class="text-gray-400 text-sm text-center">Preview File</p>`;
            currentContext = null; // Xóa ngữ cảnh
        }

        // Gắn event cho nút delete chỉ 1 lần khi DOM đã load
        document.addEventListener("DOMContentLoaded", () => {
            const deleteBtn = document.getElementById("deleteBtn");
            deleteBtn.addEventListener("click", async () => {
                const taskId = document.getElementById("updateTaskForm").dataset.id;
                const overlay = document.getElementById("loadingOverlay");
                overlay.classList.remove("hidden");
                console.log(taskId);
                if (!taskId) {
                    alert("⚠️ Không tìm thấy ID task để xóa!");
                    return;
                }

                if (!confirm("Bạn có chắc muốn xóa task này không?")) return;

                try {
                    const res = await fetch(`/Home/DeleteTask?id=${taskId}`, { method: "DELETE" });
                    const data = await res.json();
                    overlay.classList.add("hidden");

                    if (data.success) {
                        closeUpdateTaskModal();
                        location.reload();
                    } else {
                        console.log("❌ " + data.message);
                    }
                } catch (e) {
                    overlay.classList.add("hidden");
                    console.error("🔥 Lỗi khi xóa task:", e);
                    console.log("⚠️ Không thể xóa task. Kiểm tra lại kết nối hoặc server.");
                }
            });
        });


        // --- HÀM MỞ/ĐÓNG MODAL UPDATE ---
        function openUpdateTaskModal(projectId, taskId, task = null) {
            currentContext = { projectId, taskId }; // Lưu lại i và j

            if(task){
                console.log(task.id);
                
                document.getElementById("taskAssignee").setAttribute("disabled", true);
                document.getElementById("updateTaskForm").setAttribute("data-id", task.id);
                if(task.projId){
                    document.getElementById("updateTaskForm").setAttribute("data-prjid", task.projId);
                }
                if(task.assId){
                    document.getElementById("updateTaskForm").setAttribute("data-assid", task.assId);
                }

                document.getElementById("taskName").value = task.name || "";
                document.getElementById("taskAssignee").value = task.assignee || "";
                document.getElementById("taskDesc").value = task.desc || "";
                document.getElementById("taskStart").value =
                (() => {
                  const p = task.start.split(" ")[0].split("/");
                  return `${p[2]}-${p[1]}-${p[0]}`;
                })();
                document.getElementById("taskEnd").value =
                (() => {
                  const p = task.end.split(" ")[0].split("/");
                  return `${p[2]}-${p[1]}-${p[0]}`;
                })();

                const projectSelect = document.getElementById("project");
                projectSelect.setAttribute("disabled", true);
                if (task.projId) {
                    const options = Array.from(projectSelect.options);
                    const match = options.find(opt =>
                        opt.value.trim().toLowerCase() === task.projId.trim().toLowerCase()
                    );

                    if (match) {
                        projectSelect.value = match.value; // gán value tương ứng
                    }
                }
                const departSelect = document.getElementById("department");
                if (task.depart) {
                    const options = Array.from(departSelect.options);
                    const match = options.find(opt =>
                        opt.text.trim().toLowerCase() === task.depart.trim().toLowerCase()
                    );

                    if (match) {
                        departSelect.value = match.value; // gán value tương ứng
                    }
                }

                const statusSelect = document.getElementById("taskStatus");
                if (task.status) {
                    statusSelect.value = task.status;
                }
                const priorSelect = document.getElementById("taskPriority");
                if(task.prior){
                    priorSelect.value = task.prior;
                }
                const fileNameEdit = document.getElementById("fileNameEdit");
                const fileInputEdit = document.getElementById("fileInputEdit");
                const previewContainer = document.getElementById("previewContainerEdit");
                const existingFileInput = document.getElementById("existingFileUrl");

                fileNameEdit.textContent = "";
                previewContainer.innerHTML = `<p class="text-gray-400 text-sm text-center">Preview File</p>`;
                if (task.fileurl) {
                    console.log(task.fileurl);
                    existingFileInput.value = task.fileurl = task.fileurl;
                    console.log(existingFileInput.value);

                    fileNameEdit.textContent = task.fileurl;

                    const ext = task.fileurl.split('.').pop().toLowerCase();

                    if (["png", "jpg", "jpeg"].includes(ext)) {
                        previewContainer.innerHTML = `
                            <img src="${task.fileurl}" alt="${task.fileurl}"
                                 class="max-h-[180px] rounded-lg mx-auto" />
                        `;
                    }
                    else if (ext === "pdf") {
                        previewContainer.innerHTML = `
                            <embed src="${task.fileurl}" type="application/pdf"
                                   class="w-full h-[180px] rounded-lg" />
                        `;
                    }
                    else {
                        previewContainer.innerHTML = `
                            <div class="flex flex-col items-center justify-center text-center text-gray-300">
                                <i data-lucide="file-text" class="w-8 h-8 text-indigo-400 mb-2"></i>
                                <p class="text-sm">Tệp: <span class="font-medium text-white">${task.fileurl}</span></p>
                            </div>
                        `;
                        lucide.createIcons(); // render lại icon
                    }
                    document.getElementById("updateTaskForm").setAttribute("data-file", task.fileurl);
                }
            }
            else{
                @* document.getElementById("departmentOptions").classList.remove("hidden");
                document.getElementById("departmentDisplay").classList.add("hidden"); *@
                document.getElementById("project").removeAttribute("disabled");
                document.getElementById("deleteBtn").classList.add("hidden");
            }

            updateTaskModal.classList.remove("hidden");
            uploadOverlay.classList.remove("hidden");
        }

        function openUpdateProjectModal(projectId, taskId, task = null) {
            currentContext = { projectId, taskId };

            updateProjectModal.classList.remove("hidden");
            uploadOverlay.classList.remove("hidden");
        }

        function closeUpdateTaskModal() {
            updateTaskModal.classList.add("hidden");
            uploadOverlay.classList.add("hidden");
            document.getElementById("taskAssignee").setAttribute("disabled", true);
            const form = document.getElementById("updateTaskForm");
            Object.keys(form.dataset).forEach(key => delete form.dataset[key]);

            // Reset form
            updateTaskForm.reset();
            fileNameElEdit.textContent = "";
            fileNameEditProject.textContent = "";
            previewElEdit.innerHTML = `<p class="text-gray-400 text-sm text-center">Preview File</p>`;
            previewContainerEditProject.innerHTML = `<p class="text-gray-400 text-sm text-center">Preview File</p>`;
            currentContext = null; // Xóa ngữ cảnh
        }

        function closeUpdateProjectModal() {
            updateProjectModal.classList.add("hidden");
            uploadOverlay.classList.add("hidden");

            // Reset form
            updateProjectForm.reset();
            currentContext = null; // Xóa ngữ cảnh
        }

        // --- HÀM XỬ LÝ FILE (CHUNG) ---

        // Xử lý preview file cho modal UPLOAD
        function handleFile(e) {
            const file = e.target.files[0];
            previewContainer.innerHTML = "";
            if (!file) {
                fileNameEl.textContent = "";
                return;
            }

            fileNameEl.textContent = `File đã chọn: ${file.name}`;
            const fileType = file.type;

            if (fileType.startsWith("image/"))
            {
                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                img.className = "max-h-48 rounded-md border border-gray-700";
                previewContainer.appendChild(img);
            }
            else if (fileType === "application/pdf")
            {
                const iframe = document.createElement("iframe");
                iframe.src = URL.createObjectURL(file);
                iframe.className = "w-full h-48 rounded-md border border-gray-700";
                previewContainer.appendChild(iframe);
            }
            else if (fileType === "application/vnd.openxmlformats-officedocument.wordprocessingml.document" || fileType === "application/msword")
            {
                const div = document.createElement("div");
                div.className = "flex items-center gap-2 text-gray-200";
                div.innerHTML = `<i data-lucide="file-text" class="w-5 h-5 text-green-400"></i> <span>${file.name}</span>`;
                previewContainer.appendChild(div);
                lucide.createIcons();
            }
            else if (fileType === "application/vnd.ms-excel" || fileType === "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")
            {
                const div = document.createElement("div");
                div.className = "flex items-center gap-2 text-gray-200";
                div.innerHTML = `<i data-lucide="table" class="w-5 h-5 text-green-400"></i> <span>${file.name}</span>`;
                previewContainer.appendChild(div);
                lucide.createIcons();
            }
            else
            {
                previewContainer.innerHTML = `<p class="text-gray-400 text-sm text-center">Không thể xem trước loại file này.</p>`;
            }
        }

        // Shorten name
        function shortenFileName(name, maxLength = 30) {
            if (name.length <= maxLength) return name;
            const extIndex = name.lastIndexOf(".");
            const extension = extIndex !== -1 ? name.slice(extIndex) : "";
            const baseName = name.slice(0, maxLength - extension.length - 3); // trừ phần đuôi + "..."
            return baseName + "..." + extension;
        }

        // Xử lý preview file cho modal UPDATE
        function handleFileEdit(e) {
            const file = e.target.files[0];
            previewElEdit.innerHTML = "";
            if (!file) {
                fileNameElEdit.textContent = "";
                return;
            }
            document.getElementById("existingFileUrl").value = file.name;
            let shortName = shortenFileName(file.name, 25);

            fileNameElEdit.textContent = `📄 ${shortName}`;
            const fileType = file.type;
            if (fileType.startsWith("image/")) {
                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                img.className = "max-h-40 rounded-md border border-gray-700";
                previewElEdit.appendChild(img);
            } else if (fileType === "application/pdf") {
                const iframe = document.createElement("iframe");
                iframe.src = URL.createObjectURL(file);
                iframe.className = "w-full h-48 rounded-md border border-gray-700";
                previewElEdit.appendChild(iframe);
            } else {
                previewElEdit.innerHTML = `<p class="text-gray-400 text-sm text-center">Không thể xem trước loại file này.</p>`;
            }
        }
        function handleFileEditPro(e) {
            const file = e.target.files[0];
            previewContainerEditProject.innerHTML = "";
            if (!file) {
                fileNameEditProject.textContent = "";
                return;
            }
            let shortName = shortenFileName(file.name, 24);

            fileNameEditProject.textContent = `📄 ${shortName}`;
            const fileType = file.type;
            if (fileType.startsWith("image/")) {
                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                img.className = "max-h-40 rounded-md border border-gray-700";
                previewContainerEditProject.appendChild(img);
            } else if (fileType === "application/pdf") {
                const iframe = document.createElement("iframe");
                iframe.src = URL.createObjectURL(file);
                iframe.className = "w-full h-48 rounded-md border border-gray-700";
                previewContainerEditProject.appendChild(iframe);
            } else {
                previewContainerEditProject.innerHTML = `<p class="text-gray-400 text-sm text-center">Không thể xem trước loại file này.</p>`;
            }
        }

        // --- HÀM DOWNLOAD/VIEW (DEMO) ---
        // (Những hàm này đã được gọi từ HTML nên giữ nguyên)
        function downloadFile(nameFile, urlFile) {
            if (!urlFile || urlFile === "{}") {
                alert("Không có file để xem!");
                return;
            }
            const link = document.createElement("a");
            link.href = urlFile;
            link.download = nameFile;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function viewFile(urlFile) {
            if (!urlFile || urlFile === "{}") {
                alert("Không có file để xem!");
                return;
            }
            window.open(urlFile, "_blank");
        }


        // --- GÁN SỰ KIỆN KHI DOM SẴN SÀNG ---
        document.addEventListener("DOMContentLoaded", () => {
            lucide.createIcons(); // Gọi lại để render icon (nếu cần)

            // 1. GÁN SỰ KIỆN CHO CÁC NÚT MỞ MODAL UPLOAD
            // Lấy tất cả nút "Thêm file" của DỰ ÁN
            document.querySelectorAll('[id^="addFileBtn#"]').forEach(btn => {
                btn.addEventListener("click", () => {
                    const idParts = btn.id.split('#'); // Tách "addFileBtn-i"
                    const i = idParts[1];
                    openUploadModal(i);
                });
            });

            // Lấy tất cả nút "Thêm file" của TASK
            document.querySelectorAll('[id^="addFileBtnTask#"]').forEach(btn => {
                btn.addEventListener("click", () => {
                    const idParts = btn.id.split('#'); // Tách "addFileBtnTask-i-j"
                    const i = idParts[1];
                    const j = idParts[2];
                    openUploadModal(i, j);
                });
            });

            // 2. GÁN SỰ KIỆN CHO CÁC NÚT MỞ MODAL UPDATE
            // Lấy tất cả nút "Cập nhật task"
            document.querySelectorAll('[id^="openUpdateTaskBtn#"]').forEach(btn => {
                btn.addEventListener("click", () => {
                    const idParts = btn.id.split('#'); // Tách "openUpdateTaskBtn-i-j"
                    const i = idParts[1];
                    const j = idParts[2];

                    @* console.log(btn.dataset.name); *@
                    @* console.log("1681: "+btn.dataset.assid); *@
                    @* console.log("1682: "+btn.dataset.prjid); *@

                    // Data
                    const task = {
                        id: btn.dataset.id,
                        name: btn.dataset.name,
                        projId: btn.dataset.prjid,
                        assId: btn.dataset.assid,
                        assignee: btn.dataset.assignee,
                        depart: btn.dataset.depart,
                        departId: btn.dataset.departId,
                        desc: btn.dataset.desc,
                        start: btn.dataset.start,
                        end: btn.dataset.end,
                        status: btn.dataset.status,
                        prior: btn.dataset.prior,
                        progress: btn.dataset.progress,
                        fileurl: btn.dataset.fileurl,
                    }

                    openUpdateTaskModal(i, j, task);
                });
            });

            document.querySelectorAll('[id^="openUpdateTaskBtnAdd#"]').forEach(btn => {
                btn.addEventListener("click", () => {
                    const idParts = btn.id.split('#'); // Tách "openUpdateTaskBtn-i-j"
                    const i = idParts[1];
                    const j = idParts[2];

                    openUpdateTaskModal(i, j);
                });
            });
            document.querySelectorAll('[id^="openUpdateProjectBtnAdd#"]').forEach(btn => {
                btn.addEventListener("click", () => {
                    const idParts = btn.id.split('#'); // Tách "openUpdateTaskBtn-i-j"
                    const i = idParts[1];
                    const j = idParts[2];

                    openUpdateProjectModal(i, j);
                });
            });

            // 3. GÁN SỰ KIỆN ĐÓNG MODAL
            // Nút X trên modal Update
            closeUpdateTaskBtn.addEventListener("click", closeUpdateTaskModal);
            closeUpdateProjectBtn.addEventListener("click", closeUpdateProjectModal);

            // OPTIONAL: đóng bằng phím Esc
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeUploadModal();
                    closeUpdateTaskModal();
                    closeUpdateProjectModal();
                }
            });


            // 4. GÁN SỰ KIỆN CHO FORM UPLOAD
            uploadForm.addEventListener("submit", (e) => {
                e.preventDefault();
                const file = fileInput.files[0];
                if (file) {
                    // Sử dụng currentContext để biết upload cho ai
                    let contextMsg = `Dự án ${currentContext.projectId}`;
                    if (currentContext.taskId !== null) {
                        contextMsg += `, Task ${currentContext.taskId}`;
                    }
                    // Bạn sẽ không dùng alert, đây là ví dụ
                    alert(`File "${file.name}" đã được upload cho ${contextMsg}!`);
                    closeUploadModal();
                } else {
                    alert("Vui lòng chọn file trước khi upload!");
                }
            });

            // Drag & Drop cho Upload Modal
            fileInput.addEventListener("change", handleFile);
            dropZone.addEventListener("dragover", (e) => {
                e.preventDefault();
                dropZone.classList.add("bg-indigo-600/10", "border-indigo-400");
            });
            dropZone.addEventListener("dragleave", () => {
                dropZone.classList.remove("bg-indigo-600/10", "border-indigo-400");
            });
            dropZone.addEventListener("drop", (e) => {
                e.preventDefault();
                dropZone.classList.remove("bg-indigo-600/10", "border-indigo-400");
                fileInput.files = e.dataTransfer.files;
                handleFile({ target: fileInput }); // Giả lập sự kiện change
            });

            dropZoneProject.addEventListener("dragover", (e) => {
                e.preventDefault();
                dropZoneProject.classList.add("bg-indigo-600/10", "border-indigo-400");
            });
            dropZoneProject.addEventListener("dragleave", () => {
                dropZoneProject.classList.remove("bg-indigo-600/10", "border-indigo-400");
            });
            dropZoneProject.addEventListener("drop", (e) => {
                e.preventDefault();
                dropZoneProject.classList.remove("bg-indigo-600/10", "border-indigo-400");
                fileInput.files = e.dataTransfer.files;
                handleFile({ target: fileInput }); // Giả lập sự kiện change
            });


            // 5. GÁN SỰ KIỆN CHO FORM UPDATE
            updateTaskForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const form = document.getElementById("updateTaskForm");
                const overlay = document.getElementById("loadingOverlay");
                overlay.classList.remove("hidden");
                let idT = document.getElementById("updateTaskForm").dataset.id || "";
                let prjidT = document.getElementById("updateTaskForm").dataset.prjid || document.getElementById("project").value;
                let assidT = document.getElementById("taskAssigneeId").value || document.getElementById("updateTaskForm").dataset.assid;
                @* let assidT = document.getElementById("updateTaskForm").dataset.assid || ""; *@
                let file = document.getElementById("updateTaskForm").dataset.file || "";
                let newFile = document.getElementById("existingFileUrl").value;
                let nameT = document.getElementById("taskName").value;
                let depT = document.getElementById("department").value;
                let assT = document.getElementById("taskAssignee").value;
                let descT = document.getElementById("taskDesc").value || "Không có";
                let start = document.getElementById("taskStart").value || new Date().toISOString();
                let end = document.getElementById("taskEnd").value;
                let status = document.getElementById("taskStatus").value;
                let prior = document.getElementById("taskPriority").value;

                @* if(assidT == null || assidT == ""){
                    alert("Vui lòng nhập tên đúng thành viên");
                } *@

                const t = {
                    id: idT,
                    name: nameT,
                    prior: prior,
                    file: newFile != "" ? "/resources/"+newFile : null,
                    desc: descT,
                    start: start,
                    end: end,
                    idass: assidT,
                    idprj: prjidT,
                    status: status,
                };

                
                console.log(t);

                var notChange = document.getElementById("updateTaskForm").dataset.assid != "";
                @* if(notChange){
                    closeUpdateTaskModal();
                    return;
                } *@

                var valid = t.idass != "";
                if(valid){
                    try {
                        const res = await fetch("/Home/SaveTask", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(t)
                        });

                        const data = await res.json();
                        overlay.classList.add("hidden");

                        if (data.success) {
                            @* alert("✅ Lưu task thành công!"); *@
                            closeUpdateTaskModal();
                            location.reload();
                        } else {
                            alert("❌ Lưu thất bại: " + (data.message || "Không rõ lỗi"));
                        }
                    } catch (ex) {
                        overlay.classList.add("hidden");
                        console.error("🔥 Lỗi gửi dữ liệu:", ex);
                        alert("Có lỗi xảy ra khi gửi dữ liệu!");
                    }
                }
                            @* closeUpdateTaskModal(); *@
            });

            // File input cho Update Modal
            fileInputEdit.addEventListener("change", handleFileEdit);
            fileInputEditProject.addEventListener("change", handleFileEditPro);
        });
    </script>

    @* Circle Progress *@
    <script>
        document.addEventListener("DOMContentLoaded", () => {
          const radius = 15.9155;
          const circumference = 2 * Math.PI * radius;

          document.querySelectorAll("[data-progress]").forEach(wrapper => {
            const circle = wrapper.querySelector(".progress-ring");
            const text = wrapper.querySelector("span");
            if (!circle || !text) return;

            const percent = parseInt(wrapper.dataset.progress) || 0;

            circle.style.strokeDasharray = `${circumference}`;
            circle.style.strokeDashoffset = `${circumference}`;
            circle.style.transition = "stroke-dashoffset 1s ease-out, stroke 0.5s ease";

            function setProgress(value) {
              const offset = circumference - (value / 100) * circumference;
              circle.style.strokeDashoffset = offset;
              text.textContent = `${value}%`;

              // Đổi màu theo tiến độ
              if (value < 31) {
                circle.style.stroke = "#ef4444"; // đỏ
              } else if (value < 71) {
                circle.style.stroke = "#facc15"; // vàng
              } else {
                circle.style.stroke = "#22c55e"; // xanh
              }
            }

            setProgress(percent);

            wrapper.addEventListener("click", () => {
              const newPercent = prompt("Nhập phần trăm mới (0-100):", percent);
              if (newPercent === null) return;
              const value = Math.max(0, Math.min(100, parseInt(newPercent)));
              setProgress(value);
            });
          });
        });
    </script>
}